---
title: Claude Code MCP æœåŠ¡åŠ è½½æœºåˆ¶è¯¦è§£
date: 2025-01-16
permalink: /ai/claude-code/mcp-loading-mechanism.html
categories:
  - AI
  - Claude Code
---

# Claude Code MCP æœåŠ¡åŠ è½½æœºåˆ¶è¯¦è§£

æœ¬æ–‡æ·±å…¥å‰–æ Claude Code åŠ è½½ MCP (Model Context Protocol) æœåŠ¡çš„å®Œæ•´æµç¨‹,åŒ…æ‹¬é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ã€åŠ è½½é¡ºåºã€åˆå§‹åŒ–è¿‡ç¨‹ä»¥åŠå¸¸è§é—®é¢˜æ’æŸ¥ã€‚

## ä¸€ã€é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ä½“ç³»

Claude Code é‡‡ç”¨åˆ†å±‚é…ç½®ç³»ç»Ÿ,é…ç½®é¡¹æŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºåŠ è½½å’Œåˆå¹¶:

```mermaid
graph TD
    A[Claude Code å¯åŠ¨] --> B{ä¼ä¸šç®¡ç†ç­–ç•¥}
    B -->|å­˜åœ¨| C[managed-settings.json<br/>æœ€é«˜ä¼˜å…ˆçº§]
    B -->|ä¸å­˜åœ¨| D{å‘½ä»¤è¡Œå‚æ•°}
    D --> E{é¡¹ç›®çº§é…ç½®}
    E --> F[.claude/settings.local.json<br/>é¡¹ç›®æœ¬åœ°é…ç½®]
    E --> G[.claude/settings.json<br/>é¡¹ç›®å…±äº«é…ç½®]
    D --> H{ç”¨æˆ·çº§é…ç½®}
    H --> I[~/.claude/settings.json<br/>ç”¨æˆ·å…¨å±€é…ç½®]

    C --> J[é…ç½®åˆå¹¶]
    F --> J
    G --> J
    I --> J
    J --> K[æœ€ç»ˆæœ‰æ•ˆé…ç½®]

    style A fill:#e1f5ff
    style K fill:#e1ffe1
    style C fill:#ffe1e1
    style F fill:#fff4e1
```

### é…ç½®ä¼˜å…ˆçº§è¯¦è§£

| ä¼˜å…ˆçº§ | é…ç½®æ¥æº | ä½ç½® | ç”¨é€” | å¯ä¿®æ”¹æ€§ |
|--------|---------|------|------|---------|
| **1 (æœ€é«˜)** | ä¼ä¸šç®¡ç†ç­–ç•¥ | ä¼ä¸šåˆ†å‘ | ç»„ç»‡å¼ºåˆ¶ç­–ç•¥ | åªè¯» |
| **2** | å‘½ä»¤è¡Œå‚æ•° | å¯åŠ¨å‚æ•° | ä¸´æ—¶è¦†ç›–é…ç½® | æ¯æ¬¡å¯åŠ¨æŒ‡å®š |
| **3** | é¡¹ç›®æœ¬åœ°é…ç½® | `.claude/settings.local.json` | ä¸ªäººå¼€å‘åå¥½ | ä¸çº³å…¥ç‰ˆæœ¬æ§åˆ¶ |
| **4** | é¡¹ç›®å…±äº«é…ç½® | `.claude/settings.json` | å›¢é˜Ÿå…±äº«é…ç½® | çº³å…¥ç‰ˆæœ¬æ§åˆ¶ |
| **5 (æœ€ä½)** | ç”¨æˆ·å…¨å±€é…ç½® | `~/.claude/settings.json` | ä¸ªäººé»˜è®¤é…ç½® | å…¨å±€ç”Ÿæ•ˆ |

## äºŒã€MCP é…ç½®æ–‡ä»¶ä½ç½®å’Œä½œç”¨åŸŸ

### 2.1 MCP ç‰¹æ®Šé…ç½®è§„åˆ™

**é‡è¦è¯´æ˜**: MCP æœåŠ¡å™¨é…ç½®æœ‰ç‰¹æ®Šçš„è¯†åˆ«è§„åˆ™,ä¸æ™®é€šé…ç½®é¡¹ä¸åŒã€‚

```mermaid
graph TB
    A[MCP é…ç½®è¯†åˆ«] --> B{é¡¹ç›®çº§ .mcp.json}
    B -->|å­˜åœ¨| C[è¯»å–é¡¹ç›® MCP é…ç½®]
    B -->|ä¸å­˜åœ¨| D{ç”¨æˆ·çº§ ~/.claude.json}
    D -->|å­˜åœ¨| E[è¯»å–ç”¨æˆ· MCP é…ç½®]
    D -->|ä¸å­˜åœ¨| F[æ—  MCP æœåŠ¡]

    C --> G[å¯ç”¨åˆ—è¡¨è¿‡æ»¤]
    E --> G
    G --> H[enabledMcpjsonServers]
    H --> I[æœ€ç»ˆåŠ è½½çš„ MCP æœåŠ¡]

    style A fill:#e1f5ff
    style C fill:#e1ffe1
    style E fill:#fff4e1
    style F fill:#ffe1e1
```

### 2.2 MCP é…ç½®æ–‡ä»¶å¯¹æ¯”

| é…ç½®æ–‡ä»¶ | è·¯å¾„ | ä½œç”¨åŸŸ | ä¼˜å…ˆçº§ | ç‰ˆæœ¬æ§åˆ¶ | è¯´æ˜ |
|---------|------|--------|--------|---------|------|
| **`.mcp.json`** | é¡¹ç›®æ ¹ç›®å½• | é¡¹ç›®çº§ | **æœ€é«˜** | å»ºè®®çº³å…¥ | MCP ä¸“ç”¨é…ç½® |
| **`.claude/settings.local.json`** | é¡¹ç›®/.claude/ | é¡¹ç›®æœ¬åœ° | é«˜ | ä¸çº³å…¥ | åŒ…å« MCP å¯ç”¨åˆ—è¡¨ |
| **`~/.claude.json`** | ç”¨æˆ·ä¸»ç›®å½• | ç”¨æˆ·å…¨å±€ | ä¸­ | ä¸é€‚ç”¨ | å…¨å±€ MCP é…ç½® |
| **`~/.claude/settings.json`** | ç”¨æˆ·ä¸»ç›®å½• | ç”¨æˆ·å…¨å±€ | ä½ | ä¸é€‚ç”¨ | âš ï¸ MCP é…ç½®ä¼šè¢«å¿½ç•¥ |

### 2.3 é…ç½®æ–‡ä»¶ç¤ºä¾‹

#### é¡¹ç›®çº§ MCP é…ç½® (`.mcp.json`)

```json
{
  "mcpServers": {
    "context7": {
      "command": "/opt/homebrew/bin/context7-mcp",
      "args": [],
      "env": {
        "CONTEXT7_API_KEY": "ctx7sk-..."
      }
    },
    "playwright": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-playwright"],
      "env": {}
    }
  }
}
```

#### é¡¹ç›®æœ¬åœ°é…ç½® (`.claude/settings.local.json`)

```json
{
  "permissions": {
    "allow": [
      "mcp__context7__*",
      "mcp__playwright__*"
    ]
  },
  "enabledMcpjsonServers": [
    "context7",
    "playwright"
  ]
}
```

## ä¸‰ã€MCP æœåŠ¡åŠ è½½å®Œæ•´æµç¨‹

### 3.1 å¯åŠ¨åˆ°å°±ç»ªæµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant CC as Claude Code
    participant Config as é…ç½®ç³»ç»Ÿ
    participant MCP as MCP æœåŠ¡å™¨
    participant Tool as å·¥å…·æ³¨å†Œè¡¨

    User->>CC: å¯åŠ¨ Claude Code
    CC->>Config: è¯»å–é…ç½®æ–‡ä»¶

    Note over Config: æ­¥éª¤1: è¯»å–é…ç½®
    Config->>Config: åŠ è½½ managed-settings.json
    Config->>Config: åŠ è½½é¡¹ç›®çº§é…ç½®
    Config->>Config: åŠ è½½ç”¨æˆ·çº§é…ç½®
    Config->>Config: æŒ‰ä¼˜å…ˆçº§åˆå¹¶

    Config-->>CC: è¿”å›æœ€ç»ˆé…ç½®

    Note over CC: æ­¥éª¤2: è§£æ MCP é…ç½®
    alt å­˜åœ¨ .mcp.json
        CC->>Config: è¯»å– .mcp.json
        Config-->>CC: è¿”å› MCP æœåŠ¡å®šä¹‰
    else ä¸å­˜åœ¨ .mcp.json
        CC->>Config: è¯»å– ~/.claude.json
        Config-->>CC: è¿”å› MCP æœåŠ¡å®šä¹‰
    end

    Note over CC: æ­¥éª¤3: è¿‡æ»¤å¯ç”¨çš„æœåŠ¡
    CC->>Config: æ£€æŸ¥ enabledMcpjsonServers
    Config-->>CC: è¿”å›å¯ç”¨çš„æœåŠ¡åˆ—è¡¨

    Note over CC,MCP: æ­¥éª¤4: å¯åŠ¨ MCP æœåŠ¡
    loop æ¯ä¸ªå·²å¯ç”¨çš„ MCP æœåŠ¡
        CC->>MCP: å¯åŠ¨è¿›ç¨‹ (command + args)
        MCP->>MCP: åˆå§‹åŒ–æœåŠ¡è¿›ç¨‹
        MCP-->>CC: è¿›ç¨‹å°±ç»ª

        Note over CC,MCP: æ­¥éª¤5: åè®®æ¡æ‰‹
        CC->>MCP: initialize(protocolVersion, capabilities)
        MCP-->>CC: è¿”å›æœåŠ¡å™¨ä¿¡æ¯å’Œèƒ½åŠ›

        CC->>MCP: initialized (ç¡®è®¤é€šçŸ¥)

        Note over CC,MCP: æ­¥éª¤6: è·å–å·¥å…·åˆ—è¡¨
        CC->>MCP: tools/list
        MCP-->>CC: è¿”å›å¯ç”¨å·¥å…·åˆ—è¡¨

        Note over CC,Tool: æ­¥éª¤7: æ³¨å†Œå·¥å…·
        CC->>Tool: æ³¨å†Œå·¥å…· (mcp__æœåŠ¡å__å·¥å…·å)
        Tool-->>CC: æ³¨å†ŒæˆåŠŸ
    end

    CC->>User: MCP æœåŠ¡åŠ è½½å®Œæˆ

    Note over CC,MCP: æ­¥éª¤8: è¿è¡Œæ—¶è°ƒç”¨
    User->>CC: å‘é€è¯·æ±‚
    CC->>Tool: æŸ¥æ‰¾å·¥å…·
    Tool->>MCP: tools/call(å·¥å…·å, å‚æ•°)
    MCP->>MCP: æ‰§è¡Œå·¥å…·é€»è¾‘
    MCP-->>Tool: è¿”å›æ‰§è¡Œç»“æœ
    Tool-->>CC: è¿”å›ç»“æœ
    CC-->>User: æ˜¾ç¤ºç»“æœ
```

### 3.2 åŠ è½½é˜¶æ®µè¯¦è§£

#### é˜¶æ®µ 1: é…ç½®è¯»å–ä¸åˆå¹¶

```typescript
class ConfigurationManager {
  async loadConfiguration(): Promise<Config> {
    const configs = [];

    // 1. ä¼ä¸šç®¡ç†ç­–ç•¥ (æœ€é«˜ä¼˜å…ˆçº§)
    if (await exists('managed-settings.json')) {
      configs.push(await readJson('managed-settings.json'));
    }

    // 2. é¡¹ç›®æœ¬åœ°é…ç½®
    if (await exists('.claude/settings.local.json')) {
      configs.push(await readJson('.claude/settings.local.json'));
    }

    // 3. é¡¹ç›®å…±äº«é…ç½®
    if (await exists('.claude/settings.json')) {
      configs.push(await readJson('.claude/settings.json'));
    }

    // 4. ç”¨æˆ·å…¨å±€é…ç½®
    if (await exists('~/.claude/settings.json')) {
      configs.push(await readJson('~/.claude/settings.json'));
    }

    // åˆå¹¶é…ç½® (é«˜ä¼˜å…ˆçº§è¦†ç›–ä½ä¼˜å…ˆçº§)
    return mergeConfigs(configs);
  }
}
```

#### é˜¶æ®µ 2: MCP é…ç½®è§£æ

```typescript
class MCPConfigLoader {
  async loadMCPConfig(): Promise<MCPServers> {
    let mcpConfig: MCPServers;

    // ä¼˜å…ˆä» .mcp.json è¯»å–
    if (await exists('.mcp.json')) {
      mcpConfig = await readJson('.mcp.json');
      console.log('Loaded MCP config from .mcp.json');
    }
    // å…¶æ¬¡ä»ç”¨æˆ·ç›®å½•è¯»å–
    else if (await exists('~/.claude.json')) {
      mcpConfig = await readJson('~/.claude.json');
      console.log('Loaded MCP config from ~/.claude.json');
    }
    // æ—  MCP é…ç½®
    else {
      console.log('No MCP configuration found');
      return {};
    }

    return mcpConfig.mcpServers || {};
  }
}
```

#### é˜¶æ®µ 3: æœåŠ¡å¯ç”¨è¿‡æ»¤

```typescript
class MCPServiceFilter {
  filterEnabledServices(
    allServers: MCPServers,
    enabledList: string[]
  ): MCPServers {
    // å¦‚æœæ²¡æœ‰æŒ‡å®šå¯ç”¨åˆ—è¡¨,é»˜è®¤å¯ç”¨æ‰€æœ‰
    if (!enabledList || enabledList.length === 0) {
      return allServers;
    }

    // æ ¹æ®å¯ç”¨åˆ—è¡¨è¿‡æ»¤
    const enabled: MCPServers = {};
    for (const serverName of enabledList) {
      if (allServers[serverName]) {
        enabled[serverName] = allServers[serverName];
      } else {
        console.warn(`MCP server "${serverName}" not found in configuration`);
      }
    }

    return enabled;
  }
}
```

#### é˜¶æ®µ 4: è¿›ç¨‹å¯åŠ¨

```typescript
class MCPProcessManager {
  async startMCPServer(
    name: string,
    config: MCPServerConfig
  ): Promise<ChildProcess> {
    const { command, args = [], env = {} } = config;

    console.log(`Starting MCP server: ${name}`);
    console.log(`Command: ${command} ${args.join(' ')}`);

    // å¯åŠ¨å­è¿›ç¨‹
    const process = spawn(command, args, {
      env: {
        ...process.env,
        ...env
      },
      stdio: ['pipe', 'pipe', 'pipe']
    });

    // é”™è¯¯å¤„ç†
    process.on('error', (error) => {
      console.error(`Failed to start MCP server "${name}":`, error);
    });

    process.stderr.on('data', (data) => {
      console.error(`[${name}] ${data.toString()}`);
    });

    return process;
  }
}
```

#### é˜¶æ®µ 5: åè®®æ¡æ‰‹

```typescript
class MCPClient {
  async initialize(): Promise<InitializeResult> {
    console.log('Sending initialize request');

    const initRequest = {
      jsonrpc: '2.0',
      id: this.nextId++,
      method: 'initialize',
      params: {
        protocolVersion: '2024-11-05',
        capabilities: {
          roots: { listChanged: true },
          sampling: {}
        },
        clientInfo: {
          name: 'claude-code',
          version: '1.0.0'
        }
      }
    };

    // å‘é€åˆå§‹åŒ–è¯·æ±‚
    const response = await this.sendRequest(initRequest);

    console.log('Server capabilities:', response.capabilities);
    console.log('Server info:', response.serverInfo);

    // å‘é€åˆå§‹åŒ–å®Œæˆé€šçŸ¥
    await this.sendNotification({
      jsonrpc: '2.0',
      method: 'notifications/initialized'
    });

    return response;
  }
}
```

#### é˜¶æ®µ 6: å·¥å…·å‘ç°

```typescript
class MCPClient {
  async listTools(): Promise<Tool[]> {
    console.log('Requesting tools list');

    const listRequest = {
      jsonrpc: '2.0',
      id: this.nextId++,
      method: 'tools/list',
      params: {}
    };

    const response = await this.sendRequest(listRequest);

    console.log(`Discovered ${response.tools.length} tools:`,
                response.tools.map(t => t.name));

    return response.tools;
  }
}
```

#### é˜¶æ®µ 7: å·¥å…·æ³¨å†Œ

```typescript
class ToolRegistry {
  registerMCPTools(
    serverName: string,
    tools: Tool[],
    client: MCPClient
  ): void {
    for (const tool of tools) {
      // å·¥å…·åç§°æ ¼å¼: mcp__æœåŠ¡å__å·¥å…·å
      const fullToolName = `mcp__${serverName}__${tool.name}`;

      // åˆ›å»ºå·¥å…·åŒ…è£…å™¨
      const toolWrapper = {
        name: fullToolName,
        description: tool.description,
        inputSchema: tool.inputSchema,

        // æ‰§è¡Œå‡½æ•°
        execute: async (params: any) => {
          return await client.callTool(tool.name, params);
        }
      };

      // æ³¨å†Œåˆ°å·¥å…·ç³»ç»Ÿ
      this.tools.set(fullToolName, toolWrapper);

      console.log(`âœ“ Registered tool: ${fullToolName}`);
    }
  }
}
```

### 3.3 è¿è¡Œæ—¶å·¥å…·è°ƒç”¨æµç¨‹

```mermaid
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B[Claude AI å†³ç­–]
    B --> C{éœ€è¦ä½¿ç”¨å·¥å…·?}
    C -->|æ˜¯| D[é€‰æ‹©åˆé€‚çš„å·¥å…·]
    C -->|å¦| E[ç›´æ¥å›å¤]

    D --> F[æŸ¥æ‰¾å·¥å…·å®šä¹‰]
    F --> G{å·¥å…·å­˜åœ¨?}
    G -->|æ˜¯| H[å‡†å¤‡å‚æ•°]
    G -->|å¦| I[è¿”å›é”™è¯¯]

    H --> J[è°ƒç”¨ MCP Client]
    J --> K[æ„é€  tools/call è¯·æ±‚]
    K --> L[å‘é€åˆ° MCP Server]

    L --> M[MCP Server å¤„ç†]
    M --> N[æ‰§è¡Œå·¥å…·é€»è¾‘]
    N --> O[è¿”å›ç»“æœ]

    O --> P[è§£æç»“æœ]
    P --> Q[è¿”å›ç»™ Claude]
    Q --> R[ç”Ÿæˆæœ€ç»ˆå›å¤]

    style A fill:#e1f5ff
    style R fill:#e1ffe1
    style I fill:#ffe1e1
```

## å››ã€å®é™…é…ç½®æ¡ˆä¾‹åˆ†æ

### 4.1 æ‚¨çš„é…ç½®åˆ†æ

æ ¹æ®æ‚¨çš„é…ç½®æ–‡ä»¶:

**`.mcp.json`** (å®šä¹‰ MCP æœåŠ¡):
```json
{
  "mcpServers": {
    "context7": {
      "command": "/opt/homebrew/bin/context7-mcp",
      "args": [],
      "env": {
        "CONTEXT7_API_KEY": "ctx7sk-859f2734-c5d8-4a9a-837f-e503ee46b451"
      }
    }
  }
}
```

**`.claude/settings.local.json`** (å¯ç”¨å’Œæƒé™):
```json
{
  "permissions": {
    "allow": ["mcp__context7__*"]
  },
  "enabledMcpjsonServers": ["context7"]
}
```

### 4.2 åŠ è½½æµç¨‹è¿½è¸ª

```mermaid
sequenceDiagram
    participant CC as Claude Code
    participant Config as é…ç½®ç³»ç»Ÿ
    participant Proc as è¿›ç¨‹ç®¡ç†å™¨
    participant Context7 as context7-mcp

    CC->>Config: è¯»å– .mcp.json
    Config-->>CC: { context7: {...} }

    CC->>Config: è¯»å– enabledMcpjsonServers
    Config-->>CC: ["context7"]

    Note over CC: context7 å·²å¯ç”¨,å‡†å¤‡å¯åŠ¨

    CC->>Proc: å¯åŠ¨è¿›ç¨‹
    Note right of Proc: command: /opt/homebrew/bin/context7-mcp<br/>env: CONTEXT7_API_KEY=...

    Proc->>Context7: spawn process

    alt è¿›ç¨‹å¯åŠ¨å¤±è´¥
        Context7-->>Proc: Error (æ–‡ä»¶ä¸å­˜åœ¨/æƒé™ä¸è¶³)
        Proc-->>CC: å¯åŠ¨å¤±è´¥
        CC->>CC: è®°å½•é”™è¯¯æ—¥å¿—
    else è¿›ç¨‹å¯åŠ¨æˆåŠŸ
        Context7-->>Proc: Process running
        Proc-->>CC: PID: 12345

        CC->>Context7: initialize
        Context7-->>CC: capabilities + serverInfo

        CC->>Context7: tools/list
        Context7-->>CC: [tool1, tool2, ...]

        CC->>CC: æ³¨å†Œå·¥å…· (mcp__context7__*)

        Note over CC: Context7 æœåŠ¡å°±ç»ª
    end
```

### 4.3 æ‚¨é‡åˆ°çš„è¿æ¥å¤±è´¥åŸå› 

å‘½ä»¤è¾“å‡ºæ˜¾ç¤º: `Failed to reconnect to context7`

#### å¯èƒ½çš„åŸå› åŠæ’æŸ¥æ­¥éª¤

**æ’æŸ¥æµç¨‹å›¾:**

```
è¿æ¥å¤±è´¥
   â†“
[1] æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
   â”œâ”€ æ–‡ä»¶ä¸å­˜åœ¨ â†’ å®‰è£…æˆ–ä¿®æ­£è·¯å¾„
   â””â”€ æ–‡ä»¶å­˜åœ¨ â†’ ç»§ç»­
       â†“
[2] æ£€æŸ¥æ–‡ä»¶æƒé™
   â”œâ”€ æ— æ‰§è¡Œæƒé™ â†’ chmod +x æˆæƒ
   â””â”€ æœ‰æ‰§è¡Œæƒé™ â†’ ç»§ç»­
       â†“
[3] æ£€æŸ¥ç¯å¢ƒå˜é‡
   â”œâ”€ API Key é”™è¯¯ â†’ æ›´æ–°é…ç½®
   â””â”€ API Key æ­£ç¡® â†’ ç»§ç»­
       â†“
[4] æ£€æŸ¥ç½‘ç»œè¿æ¥
   â”œâ”€ ç½‘ç»œä¸é€š â†’ æ£€æŸ¥ç½‘ç»œé…ç½®
   â””â”€ ç½‘ç»œæ­£å¸¸ â†’ ç»§ç»­
       â†“
[5] æ£€æŸ¥æœåŠ¡çŠ¶æ€
   â””â”€ æœåŠ¡ç«¯æ•…éšœ â†’ è”ç³»æœåŠ¡æä¾›å•†
```

#### è¯¦ç»†æ’æŸ¥æ­¥éª¤

| æ­¥éª¤ | æ£€æŸ¥é¡¹ | é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|-----|--------|------|---------|
| **1** | å¯æ‰§è¡Œæ–‡ä»¶ | `/opt/homebrew/bin/context7-mcp` ä¸å­˜åœ¨ | è¿è¡Œ `npm install -g context7-mcp` å®‰è£… |
| **2** | æ–‡ä»¶æƒé™ | æ— æ‰§è¡Œæƒé™ (Permission denied) | è¿è¡Œ `chmod +x /opt/homebrew/bin/context7-mcp` |
| **3** | ç¯å¢ƒå˜é‡ | `CONTEXT7_API_KEY` æœªè®¾ç½®æˆ–æ— æ•ˆ | åœ¨ `.mcp.json` ä¸­æ­£ç¡®é…ç½® API Key |
| **4** | ç½‘ç»œè¿æ¥ | æ— æ³•è®¿é—® Context7 æœåŠ¡ | æ£€æŸ¥é˜²ç«å¢™ã€ä»£ç†è®¾ç½® |
| **5** | æœåŠ¡çŠ¶æ€ | Context7 æœåŠ¡ç«¯æ•…éšœæˆ–ç»´æŠ¤ | è®¿é—® Context7 çŠ¶æ€é¡µé¢æˆ–è”ç³»æ”¯æŒ |

## äº”ã€æ•…éšœæ’æŸ¥æŒ‡å—

### 5.1 è¯Šæ–­æµç¨‹

```bash
# æ­¥éª¤ 1: æ£€æŸ¥ MCP å¯æ‰§è¡Œæ–‡ä»¶
ls -la /opt/homebrew/bin/context7-mcp

# æ­¥éª¤ 2: æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œä¾èµ–
file /opt/homebrew/bin/context7-mcp
otool -L /opt/homebrew/bin/context7-mcp  # macOS æŸ¥çœ‹ä¾èµ–

# æ­¥éª¤ 3: æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨
CONTEXT7_API_KEY="ctx7sk-..." /opt/homebrew/bin/context7-mcp

# æ­¥éª¤ 4: æŸ¥çœ‹ Claude Code æ—¥å¿—
# macOS
tail -f ~/Library/Logs/Claude/mcp-context7.log
# æˆ–æŸ¥çœ‹æ‰€æœ‰ MCP æ—¥å¿—
ls -la ~/Library/Logs/Claude/mcp-*.log

# æ­¥éª¤ 5: æµ‹è¯• API Key æœ‰æ•ˆæ€§
curl -H "Authorization: Bearer ctx7sk-..." https://api.context7.com/health
```

### 5.2 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: æ‰¾ä¸åˆ° MCP å¯æ‰§è¡Œæ–‡ä»¶

```bash
# é”™è¯¯ä¿¡æ¯
Error: spawn /opt/homebrew/bin/context7-mcp ENOENT

# è§£å†³æ–¹æ¡ˆ
# 1. æŸ¥æ‰¾å®é™…ä½ç½®
which context7-mcp

# 2. å¦‚æœæ²¡æœ‰å®‰è£…,å®‰è£… context7
npm install -g context7-mcp

# 3. æ›´æ–° .mcp.json ä¸­çš„è·¯å¾„
{
  "mcpServers": {
    "context7": {
      "command": "$(which context7-mcp)",  // æˆ–ä½¿ç”¨ç»å¯¹è·¯å¾„
      ...
    }
  }
}
```

#### é—®é¢˜ 2: æƒé™ä¸è¶³

```bash
# é”™è¯¯ä¿¡æ¯
Error: spawn /opt/homebrew/bin/context7-mcp EACCES

# è§£å†³æ–¹æ¡ˆ
chmod +x /opt/homebrew/bin/context7-mcp
```

#### é—®é¢˜ 3: API Key æ— æ•ˆ

```bash
# é”™è¯¯ä¿¡æ¯
Authentication failed: Invalid API key

# è§£å†³æ–¹æ¡ˆ
# 1. éªŒè¯ API Key æ ¼å¼
echo $CONTEXT7_API_KEY

# 2. é‡æ–°ç”Ÿæˆ API Key
# ç™»å½• Context7 æ§åˆ¶å°,ç”Ÿæˆæ–°çš„ API Key

# 3. æ›´æ–° .mcp.json
{
  "env": {
    "CONTEXT7_API_KEY": "æ–°çš„API_KEY"
  }
}
```

#### é—®é¢˜ 4: MCP æœåŠ¡æœªå¯ç”¨

```json
// é”™è¯¯: .mcp.json å®šä¹‰äº†æœåŠ¡,ä½†æœªå¯ç”¨

// è§£å†³æ–¹æ¡ˆ: åœ¨ .claude/settings.local.json ä¸­æ·»åŠ 
{
  "enabledMcpjsonServers": [
    "context7"
  ]
}
```

#### é—®é¢˜ 5: å·¥å…·æƒé™ä¸è¶³

```json
// é”™è¯¯: Permission denied for tool mcp__context7__search

// è§£å†³æ–¹æ¡ˆ: åœ¨ .claude/settings.local.json ä¸­æ·»åŠ æƒé™
{
  "permissions": {
    "allow": [
      "mcp__context7__*"  // å…è®¸æ‰€æœ‰ context7 å·¥å…·
    ]
  }
}
```

### 5.3 è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

```json
// .claude/settings.local.json
{
  "logging": {
    "level": "debug",
    "mcp": true
  }
}
```

#### æ‰‹åŠ¨æµ‹è¯• MCP Server

```bash
# å¯åŠ¨ MCP Server
/opt/homebrew/bin/context7-mcp

# å‘é€æµ‹è¯•æ¶ˆæ¯ (æ¯è¡Œä¸€ä¸ª JSON-RPC æ¶ˆæ¯)
# 1. åˆå§‹åŒ–
echo '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2024-11-05","capabilities":{},"clientInfo":{"name":"test","version":"1.0.0"}}}' | /opt/homebrew/bin/context7-mcp

# 2. åˆ—å‡ºå·¥å…·
echo '{"jsonrpc":"2.0","id":2,"method":"tools/list","params":{}}' | /opt/homebrew/bin/context7-mcp
```

## å…­ã€å…³é”®ç‰¹æ€§å’Œé™åˆ¶

### 6.1 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> Startup: Claude Code å¯åŠ¨
    Startup --> Loading: åŠ è½½ MCP é…ç½®
    Loading --> Connecting: è¿æ¥ MCP æœåŠ¡
    Connecting --> Active: æ‰€æœ‰æœåŠ¡å°±ç»ª

    Active --> Active: å¤„ç†å·¥å…·è°ƒç”¨

    Active --> Reconnecting: è¿æ¥æ–­å¼€
    Reconnecting --> Active: é‡è¿æˆåŠŸ
    Reconnecting --> Failed: é‡è¿å¤±è´¥

    Active --> Shutdown: Claude Code å…³é—­
    Failed --> Shutdown
    Shutdown --> [*]

    note right of Active
        MCP æœåŠ¡åœ¨æ•´ä¸ªä¼šè¯æœŸé—´
        ä¿æŒæ´»è·ƒ,ä¸ä¼šåŠ¨æ€å¸è½½
    end note
```

### 6.2 å…³é”®ç‰¹æ€§

| ç‰¹æ€§ | è¯´æ˜ | å½±å“ |
|-----|------|------|
| **ä¼šè¯çº§åŠ è½½** | MCP åœ¨å¯åŠ¨æ—¶åŠ è½½,è¿è¡ŒæœŸé—´ä¿æŒ | ä¿®æ”¹é…ç½®éœ€è¦é‡å¯ |
| **æ— åŠ¨æ€åŠ è½½** | ä¸æ”¯æŒè¿è¡Œæ—¶åŠ è½½/å¸è½½æœåŠ¡ | è®¡åˆ’ä¸­çš„åŠŸèƒ½ ([Issue #6638](https://github.com/anthropics/claude-code/issues/6638)) |
| **å·¥å…·åç§°å‰ç¼€** | è‡ªåŠ¨æ·»åŠ  `mcp__æœåŠ¡å__` å‰ç¼€ | é¿å…å·¥å…·åç§°å†²çª |
| **ç‹¬ç«‹è¿›ç¨‹** | æ¯ä¸ª MCP Server ç‹¬ç«‹è¿›ç¨‹ | æ•…éšœéš”ç¦»,èµ„æºéš”ç¦» |
| **Stdio é€šä¿¡** | é€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºé€šä¿¡ | ç®€å•é«˜æ•ˆ,è·¨å¹³å° |

### 6.3 æ€§èƒ½è€ƒè™‘

```typescript
// MCP è°ƒç”¨æ€§èƒ½ä¼˜åŒ–

// 1. è¿æ¥æ±  - MCP Client å¤ç”¨
class MCPClientPool {
  private clients = new Map<string, MCPClient>();

  getClient(serverName: string): MCPClient {
    return this.clients.get(serverName); // å¤ç”¨å·²æœ‰è¿æ¥
  }
}

// 2. å·¥å…·è°ƒç”¨ç¼“å­˜
class ToolCallCache {
  private cache = new LRU<string, ToolResult>({
    max: 100,
    ttl: 5000 // 5ç§’ç¼“å­˜
  });

  async callTool(tool: string, params: any): Promise<ToolResult> {
    const cacheKey = `${tool}:${JSON.stringify(params)}`;
    const cached = this.cache.get(cacheKey);

    if (cached) return cached;

    const result = await mcpClient.callTool(tool, params);
    this.cache.set(cacheKey, result);

    return result;
  }
}

// 3. æ‰¹é‡è°ƒç”¨ä¼˜åŒ–
class BatchToolExecutor {
  async executeBatch(calls: ToolCall[]): Promise<ToolResult[]> {
    // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå·¥å…·è°ƒç”¨
    return await Promise.all(
      calls.map(call => this.executeSingle(call))
    );
  }
}
```

## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 é…ç½®ç®¡ç†

```bash
# é¡¹ç›®ç»“æ„æ¨è
your-project/
â”œâ”€â”€ .mcp.json                      # MCP æœåŠ¡å®šä¹‰ (çº³å…¥ç‰ˆæœ¬æ§åˆ¶)
â”œâ”€â”€ .claude/
â”‚   â”œâ”€â”€ settings.json              # å›¢é˜Ÿå…±äº«é…ç½® (çº³å…¥ç‰ˆæœ¬æ§åˆ¶)
â”‚   â””â”€â”€ settings.local.json        # ä¸ªäººé…ç½® (ä¸çº³å…¥ç‰ˆæœ¬æ§åˆ¶)
â””â”€â”€ .gitignore                     # æ’é™¤æ•æ„Ÿé…ç½®

# .gitignore ç¤ºä¾‹
.claude/settings.local.json
.mcp.local.json
```

### 7.2 å®‰å…¨é…ç½®

```json
// âœ… æ¨è: ä½¿ç”¨ç¯å¢ƒå˜é‡
{
  "mcpServers": {
    "myapi": {
      "command": "my-mcp-server",
      "env": {
        "API_KEY": "${MY_API_KEY}"  // ä»ç¯å¢ƒå˜é‡è¯»å–
      }
    }
  }
}

// âŒ ä¸æ¨è: ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯
{
  "mcpServers": {
    "myapi": {
      "env": {
        "API_KEY": "hardcoded-secret-key"  // ä¸è¦è¿™æ ·åš!
      }
    }
  }
}
```

### 7.3 å¤šé¡¹ç›®é…ç½®ç­–ç•¥

```bash
# ç­–ç•¥ 1: é¡¹ç›®ç‹¬ç«‹é…ç½®
project-a/
  .mcp.json          # é¡¹ç›®ç‰¹å®šçš„ MCP æœåŠ¡

project-b/
  .mcp.json          # ä¸åŒçš„ MCP æœåŠ¡é…ç½®

# ç­–ç•¥ 2: å…¨å±€ + é¡¹ç›®è¦†ç›–
~/.claude.json       # å…¨å±€é€šç”¨ MCP æœåŠ¡
project-x/
  .mcp.json          # é¢å¤–çš„é¡¹ç›®ç‰¹å®šæœåŠ¡

# ç­–ç•¥ 3: ç¯å¢ƒåˆ†ç¦»
.mcp.development.json
.mcp.production.json
# ä½¿ç”¨ç¬¦å·é“¾æ¥åˆ‡æ¢
ln -s .mcp.development.json .mcp.json
```

## å…«ã€æ€»ç»“

### 8.1 åŠ è½½æœºåˆ¶è¦ç‚¹

```mermaid
mindmap
  root((MCP åŠ è½½æœºåˆ¶))
    é…ç½®ç³»ç»Ÿ
      ä¼˜å…ˆçº§é¡ºåº
      æ–‡ä»¶ä½ç½®
      åˆå¹¶è§„åˆ™
    æœåŠ¡å¯åŠ¨
      è¿›ç¨‹åˆ›å»º
      åè®®æ¡æ‰‹
      å·¥å…·å‘ç°
    è¿è¡Œæ—¶
      å·¥å…·è°ƒç”¨
      è¿æ¥ç®¡ç†
      é”™è¯¯å¤„ç†
    æ•…éšœæ’æŸ¥
      æ—¥å¿—åˆ†æ
      æ‰‹åŠ¨æµ‹è¯•
      é…ç½®éªŒè¯
```

### 8.2 å…³é”®æ£€æŸ¥æ¸…å•

åœ¨é…ç½® MCP æœåŠ¡æ—¶,è¯·ç¡®ä¿:

- [ ] MCP å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„æ­£ç¡®ä¸”æœ‰æ‰§è¡Œæƒé™
- [ ] ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½® (API Key ç­‰)
- [ ] æœåŠ¡å·²åœ¨ `enabledMcpjsonServers` ä¸­å¯ç”¨
- [ ] å·¥å…·æƒé™å·²åœ¨ `permissions.allow` ä¸­é…ç½®
- [ ] é…ç½®æ–‡ä»¶ JSON æ ¼å¼æ­£ç¡®
- [ ] MCP Server å¯ä»¥æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
- [ ] æŸ¥çœ‹ Claude Code æ—¥å¿—ç¡®è®¤åŠ è½½çŠ¶æ€

### 8.3 ä¸‹ä¸€æ­¥å­¦ä¹ 

- é˜…è¯» **[MCPåè®®æ·±å…¥è§£æ](./09.MCPåè®®å®ç°)** äº†è§£ MCP åè®®ç»†èŠ‚
- é˜…è¯» **[MCP-Serverå¼€å‘å®æˆ˜](./18.MCP-Serverå¼€å‘å®æˆ˜)** å­¦ä¹ å¼€å‘è‡ªå®šä¹‰ MCP æœåŠ¡
- å‚ä¸ [Claude Code GitHub Discussions](https://github.com/anthropics/claude-code/discussions) ç¤¾åŒºè®¨è®º

---

**å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©,æ¬¢è¿åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹!** ğŸš€
