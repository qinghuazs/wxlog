---
title: Claude Codeæ¶æ„è¯¦è§£ï¼ˆä¸€ï¼‰ï¼šæ•´ä½“æ¶æ„è®¾è®¡
date: 2025-01-14
permalink: /ai/claude-code/architecture-01-overall-architecture.html
tags:
  - Claude Code
categories:
  - Claude Code
---

# æ•´ä½“æ¶æ„è®¾è®¡

## å¼•è¨€

Claude Code æ˜¯ Anthropic æ¨å‡ºçš„ AI é©±åŠ¨çš„å‘½ä»¤è¡Œä»£ç ç¼–è¾‘å™¨ï¼Œå®ƒå°†å¼ºå¤§çš„ Claude AI æ¨¡å‹ä¸å®Œæ•´çš„å¼€å‘å·¥å…·é“¾æ·±åº¦é›†æˆã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Claude Code çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼Œå¸®åŠ©ä½ ç†è§£è¿™æ¬¾å·¥å…·çš„æŠ€æœ¯åŸºç¡€å’Œè®¾è®¡ç†å¿µã€‚

### ä¸ºä»€ä¹ˆéœ€è¦äº†è§£æ¶æ„ï¼Ÿ

1. **æ›´å¥½åœ°ä½¿ç”¨å·¥å…·**ï¼šç†è§£æ¶æ„èƒ½å¸®åŠ©ä½ æ›´é«˜æ•ˆåœ°ä½¿ç”¨ Claude Code
2. **å¼€å‘è‡ªå®šä¹‰æ‰©å±•**ï¼šä¸ºåç»­å¼€å‘ MCP Server å’Œè‡ªå®šä¹‰å·¥å…·æ‰“åŸºç¡€
3. **æ„å»ºç±»ä¼¼äº§å“**ï¼šä¸ºå¼€å‘è‡ªå·±çš„ AI ç¼–ç¨‹åŠ©æ‰‹æä¾›å‚è€ƒ
4. **æŠ€æœ¯é€‰å‹å‚è€ƒ**ï¼šå­¦ä¹ æˆç†Ÿäº§å“çš„æ¶æ„è®¾è®¡æ€è·¯



## ä¸€ã€æŠ€æœ¯æ ˆæ¦‚è§ˆ

### 1.1 æ ¸å¿ƒæŠ€æœ¯é€‰æ‹©

```mermaid
graph TB
    A[Claude CodeæŠ€æœ¯æ ˆ] --> B[å‰ç«¯å±‚]
    A --> C[é€šä¿¡å±‚]
    A --> D[AIå±‚]
    A --> E[å·¥å…·å±‚]
    A --> F[å­˜å‚¨å±‚]

    B --> B1[Node.js]
    B --> B2[TypeScript]
    B --> B3[Commander.js CLIæ¡†æ¶]

    C --> C1[HTTP/HTTPS]
    C --> C2[WebSocketå®æ—¶é€šä¿¡]
    C --> C3[SSEæµå¼ä¼ è¾“]

    D --> D1[Claude 3.5 Sonnet]
    D --> D2[Anthropic API]
    D --> D3[Tool Calling]

    E --> E1[æ–‡ä»¶ç³»ç»Ÿæ“ä½œ]
    E --> E2[è¿›ç¨‹ç®¡ç†]
    E --> E3[MCPåè®®]

    F --> F1[SQLiteæœ¬åœ°å­˜å‚¨]
    F --> F2[æ–‡ä»¶ç³»ç»Ÿç¼“å­˜]
    F --> F3[JSONé…ç½®æ–‡ä»¶]

    style A fill:#e1f5ff,stroke:#333,stroke-width:3px
    style D1 fill:#ffe1f5,stroke:#333,stroke-width:2px
```

### 1.2 æŠ€æœ¯æ ˆè¯¦è§£

| å±‚çº§ | æŠ€æœ¯ | ä½œç”¨ | é€‰æ‹©ç†ç”± |
|------|------|------|---------|
| **å‰ç«¯äº¤äº’** | Node.js + TypeScript | CLI åº”ç”¨ä¸»æ¡†æ¶ | è·¨å¹³å°ã€ç”Ÿæ€ä¸°å¯Œã€ç±»å‹å®‰å…¨ |
| **å‘½ä»¤è§£æ** | Commander.js | å‘½ä»¤è¡Œå‚æ•°å¤„ç† | æˆç†Ÿç¨³å®šã€æ˜“ç”¨ |
| **AI å¼•æ“** | Claude 3.5 Sonnet | æ ¸å¿ƒ AI èƒ½åŠ› | å¼ºå¤§çš„ä»£ç ç†è§£å’Œç”Ÿæˆèƒ½åŠ› |
| **é€šä¿¡åè®®** | HTTP + SSE | ä¸ Anthropic API é€šä¿¡ | æ”¯æŒæµå¼å“åº” |
| **å·¥å…·è°ƒç”¨** | Tool Calling | AI è°ƒç”¨ç³»ç»Ÿå·¥å…· | Anthropic åŸç”Ÿæ”¯æŒ |
| **æ‰©å±•åè®®** | MCP (Model Context Protocol) | ç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ | æ ‡å‡†åŒ–ã€å¯æ‰©å±• |
| **æ•°æ®å­˜å‚¨** | SQLite + æ–‡ä»¶ç³»ç»Ÿ | ä¼šè¯å’Œé…ç½®æŒä¹…åŒ– | è½»é‡ã€æ— éœ€é¢å¤–æœåŠ¡ |
| **è¿›ç¨‹ç®¡ç†** | child_process | æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ | Node.js åŸç”Ÿæ”¯æŒ |



## äºŒã€æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 å››å±‚æ¶æ„æ¨¡å‹

Claude Code é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„è®¾è®¡ï¼š

```mermaid
graph TB
    subgraph "ç”¨æˆ·äº¤äº’å±‚"
        A1[CLIå‘½ä»¤æ¥å£]
        A2[äº¤äº’å¼å¯¹è¯]
        A3[æ–‡ä»¶ç›‘å¬]
    end

    subgraph "æ ¸å¿ƒå¼•æ“å±‚"
        B1[ä¼šè¯ç®¡ç†å™¨]
        B2[ä¸Šä¸‹æ–‡ç®¡ç†å™¨]
        B3[AIå¼•æ“]
        B4[å·¥å…·è°ƒåº¦å™¨]
    end

    subgraph "å·¥å…·æ‰§è¡Œå±‚"
        C1[æ–‡ä»¶æ“ä½œå·¥å…·]
        C2[ä»£ç æœç´¢å·¥å…·]
        C3[ç»ˆç«¯å·¥å…·]
        C4[MCPå·¥å…·]
        C5[æµè§ˆå™¨å·¥å…·]
    end

    subgraph "ç³»ç»Ÿæ¥å£å±‚"
        D1[æ–‡ä»¶ç³»ç»Ÿ]
        D2[è¿›ç¨‹ç®¡ç†]
        D3[ç½‘ç»œé€šä¿¡]
        D4[å¤–éƒ¨æœåŠ¡]
    end

    A1 --> B1
    A2 --> B2
    A3 --> B2

    B1 --> B3
    B2 --> B3
    B3 --> B4

    B4 --> C1
    B4 --> C2
    B4 --> C3
    B4 --> C4
    B4 --> C5

    C1 --> D1
    C2 --> D1
    C3 --> D2
    C4 --> D3
    C5 --> D4

    style B3 fill:#ffe1f5,stroke:#333,stroke-width:2px
    style B4 fill:#e1f5ff,stroke:#333,stroke-width:2px
```

### 2.2 æ¶æ„å±‚çº§è¯¦è§£

#### **ç¬¬ä¸€å±‚ï¼šç”¨æˆ·äº¤äº’å±‚**

è´Ÿè´£æ¥æ”¶ç”¨æˆ·è¾“å…¥å’Œå±•ç¤ºè¾“å‡ºã€‚

**æ ¸å¿ƒç»„ä»¶**ï¼š
- **CLI å‘½ä»¤æ¥å£**ï¼šå¤„ç†å‘½ä»¤è¡Œå‚æ•°å’Œå­å‘½ä»¤
- **äº¤äº’å¼å¯¹è¯**ï¼šç®¡ç†å¤šè½®å¯¹è¯çš„è¾“å…¥è¾“å‡º
- **æ–‡ä»¶ç›‘å¬**ï¼šç›‘æ§æ–‡ä»¶å˜åŒ–ï¼Œè§¦å‘ç›¸å…³å¤„ç†

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// CLI å…¥å£ç‚¹ç®€åŒ–ç¤ºä¾‹
import { Command } from 'commander';

const program = new Command();

program
  .name('claude-code')
  .description('AI-powered code editor')
  .version('1.0.0');

// ä¸»å¯¹è¯å‘½ä»¤
program
  .command('chat')
  .description('Start interactive chat')
  .option('-m, --message <text>', 'Initial message')
  .option('-f, --file <path>', 'Context file')
  .action(async (options) => {
    const session = new ChatSession(options);
    await session.start();
  });

// æ‰§è¡Œå•ä¸ªä»»åŠ¡
program
  .command('do <task>')
  .description('Execute a single task')
  .action(async (task) => {
    const executor = new TaskExecutor();
    await executor.run(task);
  });

program.parse();
```



#### **ç¬¬äºŒå±‚ï¼šæ ¸å¿ƒå¼•æ“å±‚**

è¿™æ˜¯ Claude Code çš„"å¤§è„‘"ï¼Œè´Ÿè´£å†³ç­–å’Œåè°ƒã€‚

**æ ¸å¿ƒç»„ä»¶**ï¼š

1. **ä¼šè¯ç®¡ç†å™¨ (Session Manager)**
   - ç®¡ç†ç”¨æˆ·ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
   - ç»´æŠ¤ä¼šè¯çŠ¶æ€å’Œå…ƒæ•°æ®
   - å¤„ç†ä¼šè¯åˆ‡æ¢å’Œæ¢å¤

2. **ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (Context Manager)**
   - æ”¶é›†å’Œç»„ç»‡ä¸Šä¸‹æ–‡ä¿¡æ¯
   - Token é¢„ç®—ç®¡ç†
   - æ™ºèƒ½æˆªæ–­å’Œä¼˜å…ˆçº§æ’åº

3. **AI å¼•æ“ (AI Engine)**
   - ä¸ Claude API é€šä¿¡
   - å¤„ç†æµå¼å“åº”
   - è§£æ AI è¾“å‡º

4. **å·¥å…·è°ƒåº¦å™¨ (Tool Dispatcher)**
   - è§£æå·¥å…·è°ƒç”¨è¯·æ±‚
   - è·¯ç”±åˆ°å¯¹åº”å·¥å…·
   - èšåˆå·¥å…·æ‰§è¡Œç»“æœ

**æ ¸å¿ƒå¼•æ“æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Session as ä¼šè¯ç®¡ç†å™¨
    participant Context as ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    participant AI as AIå¼•æ“
    participant Tool as å·¥å…·è°ƒåº¦å™¨

    User->>Session: å‘é€æ¶ˆæ¯
    Session->>Context: æ”¶é›†ä¸Šä¸‹æ–‡
    Context->>Context: Tokené¢„ç®—è®¡ç®—
    Context->>Context: ä¼˜å…ˆçº§æ’åº
    Context-->>Session: è¿”å›ä¼˜åŒ–åä¸Šä¸‹æ–‡

    Session->>AI: æ„é€ APIè¯·æ±‚
    AI->>AI: è°ƒç”¨Claude API
    AI-->>Session: æµå¼è¿”å›å“åº”

    alt AIè¯·æ±‚å·¥å…·è°ƒç”¨
        AI->>Tool: å·¥å…·è°ƒç”¨è¯·æ±‚
        Tool->>Tool: æ‰§è¡Œå·¥å…·
        Tool-->>AI: å·¥å…·æ‰§è¡Œç»“æœ
        AI->>AI: ç»§ç»­ç”Ÿæˆ
    end

    AI-->>Session: æœ€ç»ˆå“åº”
    Session-->>User: æ˜¾ç¤ºç»“æœ
```

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// AI å¼•æ“æ ¸å¿ƒé€»è¾‘ç®€åŒ–ç¤ºä¾‹
class AIEngine {
  private client: Anthropic;
  private toolDispatcher: ToolDispatcher;

  async processMessage(
    messages: Message[],
    tools: Tool[],
    options: AIOptions
  ): Promise<AIResponse> {
    // æ„é€  API è¯·æ±‚
    const request = {
      model: 'claude-3-5-sonnet-20250929',
      max_tokens: options.maxTokens || 8000,
      messages: messages,
      tools: tools,
      stream: true
    };

    // æµå¼å¤„ç†å“åº”
    const stream = await this.client.messages.create(request);

    let fullResponse = '';
    const toolCalls: ToolCall[] = [];

    for await (const chunk of stream) {
      if (chunk.type === 'content_block_start') {
        // å¤„ç†å†…å®¹å—å¼€å§‹
      } else if (chunk.type === 'content_block_delta') {
        // å¤„ç†å†…å®¹å¢é‡
        if (chunk.delta.type === 'text_delta') {
          fullResponse += chunk.delta.text;
          // å®æ—¶è¾“å‡ºç»™ç”¨æˆ·
          process.stdout.write(chunk.delta.text);
        } else if (chunk.delta.type === 'tool_use') {
          // æ”¶é›†å·¥å…·è°ƒç”¨
          toolCalls.push(chunk.delta);
        }
      }
    }

    // å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œæ‰§è¡Œå·¥å…·
    if (toolCalls.length > 0) {
      const toolResults = await this.toolDispatcher.execute(toolCalls);
      // å°†å·¥å…·ç»“æœè¿”å›ç»™AIï¼Œç»§ç»­å¯¹è¯
      return this.processMessage(
        [...messages, { role: 'assistant', content: toolCalls }, { role: 'user', content: toolResults }],
        tools,
        options
      );
    }

    return { content: fullResponse, toolCalls };
  }
}
```



#### **ç¬¬ä¸‰å±‚ï¼šå·¥å…·æ‰§è¡Œå±‚**

æä¾› AI å¯è°ƒç”¨çš„å„ç§å·¥å…·èƒ½åŠ›ã€‚

**æ ¸å¿ƒå·¥å…·åˆ†ç±»**ï¼š

```mermaid
graph LR
    A[å·¥å…·ç³»ç»Ÿ] --> B[æ–‡ä»¶æ“ä½œç±»]
    A --> C[ä»£ç æœç´¢ç±»]
    A --> D[ç³»ç»Ÿæ‰§è¡Œç±»]
    A --> E[æ‰©å±•å·¥å…·ç±»]

    B --> B1[Read - è¯»å–æ–‡ä»¶]
    B --> B2[Write - å†™å…¥æ–‡ä»¶]
    B --> B3[Edit - ç¼–è¾‘æ–‡ä»¶]

    C --> C1[Glob - æ–‡ä»¶åŒ¹é…]
    C --> C2[Grep - å†…å®¹æœç´¢]

    D --> D1[Bash - å‘½ä»¤æ‰§è¡Œ]
    D --> D2[BashOutput - è¾“å‡ºè·å–]

    E --> E1[MCPå·¥å…· - å¤–éƒ¨é›†æˆ]
    E --> E2[Browser - æµè§ˆå™¨æ“ä½œ]

    style A fill:#e1f5ff,stroke:#333,stroke-width:3px
```

**å·¥å…·å®šä¹‰ç¤ºä¾‹**ï¼š
```typescript
// å·¥å…·å®šä¹‰è§„èŒƒ
interface ToolDefinition {
  name: string;
  description: string;
  input_schema: {
    type: 'object';
    properties: Record<string, any>;
    required: string[];
  };
}

// Read å·¥å…·å®šä¹‰
const ReadTool: ToolDefinition = {
  name: 'Read',
  description: 'Reads a file from the local filesystem. Returns file contents.',
  input_schema: {
    type: 'object',
    properties: {
      file_path: {
        type: 'string',
        description: 'The absolute path to the file to read'
      },
      offset: {
        type: 'number',
        description: 'The line number to start reading from (optional)'
      },
      limit: {
        type: 'number',
        description: 'The number of lines to read (optional)'
      }
    },
    required: ['file_path']
  }
};

// å·¥å…·æ‰§è¡Œå™¨
class ReadToolExecutor implements ToolExecutor {
  async execute(input: ToolInput): Promise<ToolResult> {
    const { file_path, offset = 0, limit } = input;

    try {
      // è¯»å–æ–‡ä»¶
      const content = await fs.readFile(file_path, 'utf-8');
      const lines = content.split('\n');

      // åº”ç”¨åç§»å’Œé™åˆ¶
      const selectedLines = limit
        ? lines.slice(offset, offset + limit)
        : lines.slice(offset);

      // æ·»åŠ è¡Œå·ï¼ˆcat -n æ ¼å¼ï¼‰
      const numberedLines = selectedLines.map(
        (line, idx) => `${offset + idx + 1}\t${line}`
      );

      return {
        success: true,
        content: numberedLines.join('\n')
      };
    } catch (error) {
      return {
        success: false,
        error: `Failed to read file: ${error.message}`
      };
    }
  }
}
```



#### **ç¬¬å››å±‚ï¼šç³»ç»Ÿæ¥å£å±‚**

ä¸æ“ä½œç³»ç»Ÿå’Œå¤–éƒ¨æœåŠ¡äº¤äº’ã€‚

**æ ¸å¿ƒèƒ½åŠ›**ï¼š
- **æ–‡ä»¶ç³»ç»Ÿæ“ä½œ**ï¼šè¯»å†™æ–‡ä»¶ã€ç›®å½•éå†ã€æƒé™ç®¡ç†
- **è¿›ç¨‹ç®¡ç†**ï¼šåˆ›å»ºå­è¿›ç¨‹ã€ç®¡ç† PTYã€ä¿¡å·å¤„ç†
- **ç½‘ç»œé€šä¿¡**ï¼šHTTP è¯·æ±‚ã€WebSocketã€SSE
- **å¤–éƒ¨æœåŠ¡**ï¼šæ•°æ®åº“è¿æ¥ã€API è°ƒç”¨ã€äº‘æœåŠ¡é›†æˆ



### 2.3 æ•°æ®æµåŠ¨

å®Œæ•´çš„è¯·æ±‚-å“åº”æµç¨‹ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant CLI as CLIå±‚
    participant SM as ä¼šè¯ç®¡ç†
    participant CM as ä¸Šä¸‹æ–‡ç®¡ç†
    participant AI as AIå¼•æ“
    participant TD as å·¥å…·è°ƒåº¦
    participant FS as æ–‡ä»¶ç³»ç»Ÿ

    U->>CLI: è¾“å…¥å‘½ä»¤/æ¶ˆæ¯
    CLI->>SM: åˆ›å»º/æ¢å¤ä¼šè¯
    SM->>CM: è¯·æ±‚ä¸Šä¸‹æ–‡

    CM->>FS: è¯»å–ç›¸å…³æ–‡ä»¶
    FS-->>CM: æ–‡ä»¶å†…å®¹
    CM->>CM: è®¡ç®—Tokené¢„ç®—
    CM-->>SM: ä¼˜åŒ–åä¸Šä¸‹æ–‡

    SM->>AI: å‘é€è¯·æ±‚
    Note over AI: æ„é€ APIè¯·æ±‚<br/>åŒ…å«messages + tools

    AI->>AI: è°ƒç”¨Claude API
    AI-->>SM: æµå¼å“åº”ï¼ˆæ–‡æœ¬ï¼‰
    SM-->>U: å®æ—¶æ˜¾ç¤º

    alt éœ€è¦å·¥å…·è°ƒç”¨
        AI->>TD: å·¥å…·è°ƒç”¨è¯·æ±‚
        TD->>TD: å‚æ•°éªŒè¯
        TD->>FS: æ‰§è¡Œæ–‡ä»¶æ“ä½œ
        FS-->>TD: æ“ä½œç»“æœ
        TD-->>AI: å·¥å…·ç»“æœ

        AI->>AI: ç»§ç»­ç”Ÿæˆ
        AI-->>SM: åç»­å“åº”
        SM-->>U: æ˜¾ç¤ºç»“æœ
    end

    SM->>SM: ä¿å­˜ä¼šè¯
    SM-->>U: å®Œæˆ
```



## ä¸‰ã€ä¸ä¼ ç»Ÿ IDE çš„å¯¹æ¯”

### 3.1 æ¶æ„å·®å¼‚

| ç»´åº¦ | ä¼ ç»Ÿ IDE (VS Code) | Claude Code |
|------|-------------------|------------|
| **æ ¸å¿ƒé©±åŠ¨** | æ’ä»¶ç³»ç»Ÿ + ç”¨æˆ·æ“ä½œ | AI Agent + è‡ªä¸»å†³ç­– |
| **äº¤äº’æ–¹å¼** | GUI + å‘½ä»¤é¢æ¿ | è‡ªç„¶è¯­è¨€å¯¹è¯ |
| **æ‰©å±•æœºåˆ¶** | Extension API | MCP Protocol + Tools |
| **æ–‡ä»¶æ“ä½œ** | ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘ | AI è‡ªåŠ¨æ‰§è¡Œ |
| **ä»»åŠ¡æ‰§è¡Œ** | éœ€è¦ç”¨æˆ·é€æ­¥æ“ä½œ | AI è‡ªä¸»åˆ†è§£å’Œæ‰§è¡Œ |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | ä¾èµ–ç”¨æˆ·è®°å¿† | æ™ºèƒ½ä¸Šä¸‹æ–‡æ”¶é›† |

### 3.2 æ¶æ„å›¾å¯¹æ¯”

**ä¼ ç»Ÿ IDE æ¶æ„**ï¼š
```mermaid
graph TB
    A[ç”¨æˆ·] --> B[GUIç•Œé¢]
    B --> C[ç¼–è¾‘å™¨æ ¸å¿ƒ]
    C --> D[æ’ä»¶ç³»ç»Ÿ]
    D --> E1[æ–‡ä»¶ç³»ç»Ÿ]
    D --> E2[Gitæ’ä»¶]
    D --> E3[è°ƒè¯•å™¨]
    D --> E4[ç»ˆç«¯]

    style A fill:#e8f5e9
    style B fill:#fff4e1
```

**Claude Code æ¶æ„**ï¼š
```mermaid
graph TB
    A[ç”¨æˆ·] --> B[è‡ªç„¶è¯­è¨€å¯¹è¯]
    B --> C[AI Agent]
    C --> D[å·¥å…·è°ƒåº¦ç³»ç»Ÿ]
    D --> E1[æ–‡ä»¶æ“ä½œ]
    D --> E2[ä»£ç æœç´¢]
    D --> E3[å‘½ä»¤æ‰§è¡Œ]
    D --> E4[æµè§ˆå™¨è‡ªåŠ¨åŒ–]
    D --> E5[MCPæ‰©å±•]

    style A fill:#e8f5e9
    style C fill:#ffe1f5,stroke:#333,stroke-width:2px
```

### 3.3 ä¼˜åŠ¿ä¸é™åˆ¶

**Claude Code çš„ä¼˜åŠ¿**ï¼š
- âœ… è‡ªç„¶è¯­è¨€äº¤äº’ï¼Œå­¦ä¹ æˆæœ¬ä½
- âœ… AI è‡ªä¸»å†³ç­–ï¼Œå‡å°‘é‡å¤æ“ä½œ
- âœ… æ™ºèƒ½ç†è§£ä¸Šä¸‹æ–‡ï¼Œå‡å°‘æ‰‹åŠ¨æŒ‡å®š
- âœ… è·¨å·¥å…·ååŒï¼Œä¸€ç«™å¼å®Œæˆä»»åŠ¡

**Claude Code çš„é™åˆ¶**ï¼š
- âš ï¸ ä¾èµ–ç½‘ç»œè¿æ¥ï¼ˆAPI è°ƒç”¨ï¼‰
- âš ï¸ æœ‰ API æˆæœ¬
- âš ï¸ AI å¯èƒ½äº§ç”Ÿå¹»è§‰æˆ–é”™è¯¯
- âš ï¸ ä¸é€‚åˆéœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯

## å››ã€æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 4.1 Agent First

Claude Code çš„æ ¸å¿ƒç†å¿µæ˜¯ **AI Agent ä¼˜å…ˆ**ï¼Œè€Œéä¼ ç»Ÿçš„å·¥å…·ä¼˜å…ˆã€‚

**ä¼ ç»Ÿæ–¹å¼**ï¼š
```
ç”¨æˆ· â†’ é€‰æ‹©å·¥å…· â†’ é…ç½®å‚æ•° â†’ æ‰§è¡Œ â†’ æŸ¥çœ‹ç»“æœ â†’ ä¸‹ä¸€æ­¥æ“ä½œ
```

**Claude Code æ–¹å¼**ï¼š
```
ç”¨æˆ· â†’ æè¿°éœ€æ±‚ â†’ AIè‡ªä¸»å†³ç­– â†’ é€‰æ‹©å·¥å…· â†’ æ‰§è¡Œ â†’ ç»¼åˆç»“æœ â†’ ç»§ç»­æˆ–å®Œæˆ
```

**ä»£ç ä½“ç°**ï¼š
```typescript
// ä¼ ç»Ÿå·¥å…·è°ƒç”¨ï¼ˆç”¨æˆ·é©±åŠ¨ï¼‰
async function traditionalApproach() {
  // ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨æ¯ä¸ªå·¥å…·
  const files = await glob('**/*.ts');
  const content = await readFile(files[0]);
  const analysis = await analyzeCode(content);
  // ...éœ€è¦ç”¨æˆ·å†³å®šæ¯ä¸€æ­¥
}

// Claude Code æ–¹å¼ï¼ˆAIé©±åŠ¨ï¼‰
async function claudeCodeApproach(userRequest: string) {
  // AIç†è§£éœ€æ±‚ï¼Œè‡ªä¸»å†³ç­–
  const response = await aiEngine.process(userRequest);
  // AI å†…éƒ¨ä¼šï¼š
  // 1. ç†è§£éœ€æ±‚ï¼š"åˆ†æTypeScriptä»£ç "
  // 2. å†³ç­–ï¼šéœ€è¦å…ˆæ‰¾åˆ°æ–‡ä»¶
  // 3. è°ƒç”¨Globå·¥å…·
  // 4. è°ƒç”¨Readå·¥å…·
  // 5. åˆ†æä»£ç 
  // 6. ç”ŸæˆæŠ¥å‘Š
  // æ‰€æœ‰è¿™äº›æ­¥éª¤AIè‡ªä¸»å®Œæˆ
}
```

### 4.2 Context is King

ä¸Šä¸‹æ–‡æ˜¯ Claude Code èƒ½å¤Ÿé«˜æ•ˆå·¥ä½œçš„å…³é”®ã€‚

**ä¸Šä¸‹æ–‡æ¥æº**ï¼š
1. **æ–‡ä»¶å†…å®¹**ï¼šå½“å‰ç¼–è¾‘çš„æ–‡ä»¶ã€ç›¸å…³ä»£ç æ–‡ä»¶
2. **é¡¹ç›®ä¿¡æ¯**ï¼špackage.jsonã€READMEã€git çŠ¶æ€
3. **å¯¹è¯å†å²**ï¼šä¹‹å‰çš„å¯¹è¯å’Œæ“ä½œè®°å½•
4. **ç³»ç»Ÿä¿¡æ¯**ï¼šOSã€è·¯å¾„ã€ç¯å¢ƒå˜é‡
5. **å·¥å…·è¾“å‡º**ï¼šæ‰§è¡Œå‘½ä»¤çš„ç»“æœã€é”™è¯¯ä¿¡æ¯

**ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§**ï¼ˆå½“ Token é¢„ç®—ä¸è¶³æ—¶ï¼‰ï¼š
```typescript
// ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§ç­–ç•¥
const contextPriority = [
  { type: 'current_file', priority: 10 },        // æœ€é«˜ä¼˜å…ˆçº§
  { type: 'recent_edits', priority: 9 },
  { type: 'error_messages', priority: 8 },
  { type: 'related_files', priority: 7 },
  { type: 'project_structure', priority: 6 },
  { type: 'recent_conversation', priority: 5 },
  { type: 'git_diff', priority: 4 },
  { type: 'documentation', priority: 3 },
  { type: 'old_conversation', priority: 2 },     // æœ€ä½ä¼˜å…ˆçº§
];
```

### 4.3 Tool Calling Native

Claude åŸç”Ÿæ”¯æŒ Tool Callingï¼Œè¿™æ˜¯æ¶æ„çš„æ ¸å¿ƒåŸºç¡€ã€‚

**Tool Calling å·¥ä½œæµ**ï¼š
```mermaid
graph LR
    A[ç”¨æˆ·è¯·æ±‚] --> B[AIåˆ†æ]
    B --> C{éœ€è¦å·¥å…·?}
    C -->|æ˜¯| D[é€‰æ‹©å·¥å…·]
    C -->|å¦| E[ç›´æ¥å›ç­”]

    D --> F[æ„é€ å‚æ•°]
    F --> G[è°ƒç”¨å·¥å…·]
    G --> H[è·å–ç»“æœ]
    H --> I[ç»§ç»­æ¨ç†]
    I --> C

    E --> J[è¿”å›ç»“æœ]
    I --> J

    style B fill:#ffe1f5
    style G fill:#e1f5ff
```

**API å±‚é¢çš„å®ç°**ï¼š
```typescript
// Anthropic API çš„ Tool Calling
const response = await anthropic.messages.create({
  model: 'claude-3-5-sonnet-20250929',
  max_tokens: 8000,
  messages: [
    { role: 'user', content: 'å¸®æˆ‘è¯»å–README.mdå¹¶æ€»ç»“å†…å®¹' }
  ],
  tools: [
    {
      name: 'read_file',
      description: 'Read a file from the filesystem',
      input_schema: {
        type: 'object',
        properties: {
          path: { type: 'string', description: 'File path' }
        },
        required: ['path']
      }
    }
  ]
});

// Claude ä¼šå†³å®šè°ƒç”¨å·¥å…·
if (response.stop_reason === 'tool_use') {
  const toolUse = response.content.find(c => c.type === 'tool_use');
  // toolUse.name === 'read_file'
  // toolUse.input === { path: 'README.md' }

  // æ‰§è¡Œå·¥å…·
  const result = await executeTools(toolUse);

  // å°†ç»“æœè¿”å›ç»™Claude
  const finalResponse = await anthropic.messages.create({
    model: 'claude-3-5-sonnet-20250929',
    messages: [
      ...previousMessages,
      { role: 'assistant', content: response.content },
      { role: 'user', content: [{ type: 'tool_result', tool_use_id: toolUse.id, content: result }] }
    ]
  });
}
```

### 4.4 Extensibility via MCP

MCP (Model Context Protocol) æ˜¯æ‰©å±•æ€§çš„æ ¸å¿ƒã€‚

**MCP çš„ä½œç”¨**ï¼š
- æ ‡å‡†åŒ–å·¥å…·å®šä¹‰
- æ”¯æŒç¬¬ä¸‰æ–¹å·¥å…·é›†æˆ
- æ’ä»¶åŒ–æ¶æ„
- ç¤¾åŒºç”Ÿæ€å»ºè®¾

**MCP å·¥ä½œåŸç†**ï¼ˆç®€åŒ–ï¼‰ï¼š
```typescript
// MCP Server æ¥å£
interface MCPServer {
  name: string;
  tools: ToolDefinition[];
  execute(toolName: string, params: any): Promise<any>;
}

// Claude Code åŠ è½½ MCP Server
class MCPLoader {
  private servers: Map<string, MCPServer> = new Map();

  async loadServer(serverPath: string) {
    const server = await import(serverPath);
    this.servers.set(server.name, server);

    // å°† MCP å·¥å…·æ³¨å†Œåˆ°å·¥å…·ç³»ç»Ÿ
    server.tools.forEach(tool => {
      toolRegistry.register(tool, (params) => {
        return server.execute(tool.name, params);
      });
    });
  }
}

// ç¤ºä¾‹ï¼šGit MCP Server
const GitMCPServer: MCPServer = {
  name: 'git',
  tools: [
    {
      name: 'git_status',
      description: 'Get git status',
      input_schema: { type: 'object', properties: {} }
    },
    {
      name: 'git_commit',
      description: 'Create a git commit',
      input_schema: {
        type: 'object',
        properties: {
          message: { type: 'string' }
        },
        required: ['message']
      }
    }
  ],
  async execute(toolName, params) {
    if (toolName === 'git_status') {
      return await execCommand('git status');
    } else if (toolName === 'git_commit') {
      return await execCommand(`git commit -m "${params.message}"`);
    }
  }
};
```



## äº”ã€æ€§èƒ½ä¸å¯æ‰©å±•æ€§

### 5.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

**1. æµå¼å“åº”**
```typescript
// ä½¿ç”¨ Server-Sent Events å®ç°æµå¼å“åº”
async function* streamResponse(prompt: string) {
  const stream = await anthropic.messages.stream({
    model: 'claude-3-5-sonnet-20250929',
    messages: [{ role: 'user', content: prompt }],
    max_tokens: 8000
  });

  for await (const chunk of stream) {
    if (chunk.type === 'content_block_delta') {
      yield chunk.delta.text;  // ç«‹å³è¾“å‡º
    }
  }
}
```

**2. å¹¶è¡Œå·¥å…·æ‰§è¡Œ**
```typescript
// å½“å¤šä¸ªå·¥å…·è°ƒç”¨ç›¸äº’ç‹¬ç«‹æ—¶ï¼Œå¹¶è¡Œæ‰§è¡Œ
async function executeToolsInParallel(toolCalls: ToolCall[]) {
  const results = await Promise.all(
    toolCalls.map(call => toolDispatcher.execute(call))
  );
  return results;
}
```

**3. æ™ºèƒ½ç¼“å­˜**
```typescript
// ç¼“å­˜æ–‡ä»¶å†…å®¹å’Œæœç´¢ç»“æœ
class SmartCache {
  private fileCache: Map<string, { content: string; mtime: number }> = new Map();
  private searchCache: Map<string, SearchResult> = new Map();

  async readFile(path: string): Promise<string> {
    const stat = await fs.stat(path);
    const cached = this.fileCache.get(path);

    if (cached && cached.mtime === stat.mtimeMs) {
      return cached.content;  // è¿”å›ç¼“å­˜
    }

    const content = await fs.readFile(path, 'utf-8');
    this.fileCache.set(path, { content, mtime: stat.mtimeMs });
    return content;
  }
}
```

### 5.2 å¯æ‰©å±•æ€§è®¾è®¡

**1. æ’ä»¶åŒ–å·¥å…·ç³»ç»Ÿ**
```typescript
// å·¥å…·æ³¨å†Œè¡¨
class ToolRegistry {
  private tools: Map<string, ToolExecutor> = new Map();

  register(definition: ToolDefinition, executor: ToolExecutor) {
    this.tools.set(definition.name, executor);
  }

  getAll(): ToolDefinition[] {
    return Array.from(this.tools.keys()).map(name => ({
      name,
      // ... å…¶ä»–å®šä¹‰
    }));
  }

  async execute(name: string, params: any): Promise<ToolResult> {
    const executor = this.tools.get(name);
    if (!executor) {
      throw new Error(`Tool ${name} not found`);
    }
    return executor.execute(params);
  }
}
```

**2. MCP Server åŠ¨æ€åŠ è½½**
```typescript
// ä»é…ç½®æ–‡ä»¶åŠ è½½ MCP Servers
async function loadMCPServers(config: Config) {
  const servers = config.mcpServers || [];

  for (const serverConfig of servers) {
    try {
      const server = await MCPLoader.load(serverConfig);
      console.log(`Loaded MCP Server: ${server.name}`);
    } catch (error) {
      console.error(`Failed to load ${serverConfig.name}:`, error);
    }
  }
}
```



## å…­ã€å®‰å…¨æ€§è®¾è®¡

### 6.1 å¤šå±‚å®‰å…¨æœºåˆ¶

```mermaid
graph TB
    A[ç”¨æˆ·è¯·æ±‚] --> B{æƒé™æ£€æŸ¥}
    B -->|é€šè¿‡| C{å‚æ•°éªŒè¯}
    B -->|æ‹’ç»| X1[è¿”å›é”™è¯¯]

    C -->|é€šè¿‡| D{éœ€è¦ç¡®è®¤?}
    C -->|å¤±è´¥| X2[è¿”å›é”™è¯¯]

    D -->|æ˜¯| E[ç”¨æˆ·ç¡®è®¤]
    D -->|å¦| F[æ‰§è¡Œå·¥å…·]

    E -->|åŒæ„| F
    E -->|æ‹’ç»| X3[å–æ¶ˆæ‰§è¡Œ]

    F --> G{æ‰§è¡ŒæˆåŠŸ?}
    G -->|æ˜¯| H[è¿”å›ç»“æœ]
    G -->|å¦| I[é”™è¯¯å¤„ç†]

    style B fill:#ffe1e1
    style D fill:#fff4e1
    style F fill:#e1f5ff
```

### 6.2 å®‰å…¨æªæ–½

**1. å‘½ä»¤ç™½åå•/é»‘åå•**
```typescript
// å±é™©å‘½ä»¤é»‘åå•
const DANGEROUS_COMMANDS = [
  'rm -rf /',
  'mkfs',
  'dd if=/dev/zero',
  'fork bomb',
  // ...
];

function validateCommand(command: string): boolean {
  for (const dangerous of DANGEROUS_COMMANDS) {
    if (command.includes(dangerous)) {
      return false;
    }
  }
  return true;
}
```

**2. æ–‡ä»¶è®¿é—®æƒé™æ§åˆ¶**
```typescript
// é™åˆ¶æ–‡ä»¶è®¿é—®èŒƒå›´
class FileAccessController {
  private workspaceRoot: string;
  private allowedPaths: Set<string>;

  async checkAccess(filePath: string): Promise<boolean> {
    const resolved = path.resolve(filePath);

    // æ£€æŸ¥æ˜¯å¦åœ¨å·¥ä½œåŒºå†…
    if (!resolved.startsWith(this.workspaceRoot)) {
      throw new Error('Access denied: outside workspace');
    }

    // æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
    if (this.allowedPaths.size > 0 && !this.allowedPaths.has(resolved)) {
      throw new Error('Access denied: not in allowed paths');
    }

    return true;
  }
}
```

**3. æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**
```typescript
// è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
function filterSensitiveInfo(content: string): string {
  // è¿‡æ»¤ API keys
  content = content.replace(/[A-Za-z0-9]{32,}/g, '***REDACTED***');

  // è¿‡æ»¤å¯†ç 
  content = content.replace(/password\s*[:=]\s*\S+/gi, 'password: ***REDACTED***');

  // è¿‡æ»¤ tokens
  content = content.replace(/token\s*[:=]\s*\S+/gi, 'token: ***REDACTED***');

  return content;
}
```



## ä¸ƒã€æœ€ä½³å®è·µ

### 7.1 æ¶æ„è®¾è®¡å»ºè®®

1. **åˆ†å±‚æ¸…æ™°**
   - ä¸¥æ ¼éµå®ˆåˆ†å±‚æ¶æ„
   - é¿å…è·¨å±‚è°ƒç”¨
   - æ¯å±‚èŒè´£å•ä¸€

2. **æ¥å£ä¼˜å…ˆ**
   - å®šä¹‰æ¸…æ™°çš„æ¥å£
   - é¢å‘æ¥å£ç¼–ç¨‹
   - ä¾¿äºæµ‹è¯•å’Œæ›¿æ¢

3. **å¯è§‚æµ‹æ€§**
   - å®Œå–„çš„æ—¥å¿—è®°å½•
   - æ€§èƒ½ç›‘æ§
   - é”™è¯¯è¿½è¸ª

4. **å®¹é”™è®¾è®¡**
   - ä¼˜é›…çš„é”™è¯¯å¤„ç†
   - é™çº§ç­–ç•¥
   - é‡è¯•æœºåˆ¶

### 7.2 å¼€å‘å»ºè®®

**æ¨¡å—åŒ–å¼€å‘**ï¼š
```typescript
// æ¨èçš„æ¨¡å—ç»“æ„
src/
â”œâ”€â”€ core/                 # æ ¸å¿ƒå¼•æ“
â”‚   â”œâ”€â”€ ai-engine.ts
â”‚   â”œâ”€â”€ context-manager.ts
â”‚   â””â”€â”€ session-manager.ts
â”œâ”€â”€ tools/               # å·¥å…·å®ç°
â”‚   â”œâ”€â”€ file-tools.ts
â”‚   â”œâ”€â”€ search-tools.ts
â”‚   â””â”€â”€ bash-tools.ts
â”œâ”€â”€ mcp/                 # MCP ç›¸å…³
â”‚   â”œâ”€â”€ loader.ts
â”‚   â””â”€â”€ registry.ts
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ token-counter.ts
â”‚   â””â”€â”€ file-watcher.ts
â””â”€â”€ cli/                 # CLI å…¥å£
    â””â”€â”€ index.ts
```

**ç±»å‹å®‰å…¨**ï¼š
```typescript
// ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
// tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true
  }
}

// å®šä¹‰æ¸…æ™°çš„ç±»å‹
interface Message {
  role: 'user' | 'assistant' | 'system';
  content: string | ContentBlock[];
  timestamp: Date;
}

interface ToolCall {
  id: string;
  type: 'tool_use';
  name: string;
  input: Record<string, any>;
}
```



## å…«ã€å¸¸è§é—®é¢˜

### Q1: Claude Code æ˜¯å¦å¼€æºï¼Ÿ
A: ç›®å‰ Claude Code ä¸æ˜¯å¼€æºçš„ï¼Œä½† Anthropic å¼€æºäº† MCP åè®®å’Œéƒ¨åˆ†ç¤ºä¾‹ä»£ç ã€‚

### Q2: å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œå—ï¼Ÿ
A: Claude Code éœ€è¦è°ƒç”¨ Anthropic APIï¼Œå› æ­¤éœ€è¦ç½‘ç»œè¿æ¥ã€‚æ ¸å¿ƒæ¨ç†åœ¨äº‘ç«¯è¿›è¡Œï¼Œæœ¬åœ°ä¸»è¦æ˜¯å·¥å…·æ‰§è¡Œå’Œç•Œé¢ã€‚

### Q3: å¦‚ä½•å¼€å‘è‡ªå®šä¹‰å·¥å…·ï¼Ÿ
A: å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ï¼š
1. å¼€å‘ MCP Serverï¼ˆæ¨èï¼‰
2. ç›´æ¥è´¡çŒ®åˆ° Claude Code é¡¹ç›®ï¼ˆå¦‚æœå¼€æºï¼‰

### Q4: æ€§èƒ½å¦‚ä½•ï¼Ÿ
A: å–å†³äºï¼š
- ç½‘ç»œå»¶è¿Ÿï¼ˆAPI è°ƒç”¨ï¼‰
- ä¸Šä¸‹æ–‡å¤§å°ï¼ˆToken æ•°é‡ï¼‰
- å·¥å…·æ‰§è¡Œæ•ˆç‡
- ä¸€èˆ¬æƒ…å†µä¸‹å“åº”é€Ÿåº¦åœ¨ 1-5 ç§’

### Q5: æˆæœ¬å¦‚ä½•ï¼Ÿ
A: åŸºäº Anthropic API å®šä»·ï¼š
- Claude 3.5 Sonnet: $3/M input tokens, $15/M output tokens
- ä¸€èˆ¬å¯¹è¯æˆæœ¬çº¦ $0.01-0.05
- å¤§å‹é¡¹ç›®åˆ†æå¯èƒ½è¾¾åˆ° $0.5-1



## ä¹ã€æ‰©å±•é˜…è¯»

### æ¨èèµ„æº
- [Anthropic API æ–‡æ¡£](https://docs.anthropic.com/)
- [MCP åè®®è§„èŒƒ](https://modelcontextprotocol.io/)
- [Tool Calling æŒ‡å—](https://docs.anthropic.com/claude/docs/tool-use)
- [Claude Code å®˜æ–¹æ–‡æ¡£](https://docs.claude.com/claude-code)

### ç›¸å…³æŠ€æœ¯
- **LangChain**ï¼šå¦ä¸€ä¸ªæµè¡Œçš„ LLM åº”ç”¨æ¡†æ¶
- **LlamaIndex**ï¼šä¸“æ³¨äº RAG çš„æ¡†æ¶
- **AutoGPT**ï¼šè‡ªä¸» AI Agent
- **VS Code Extension API**ï¼šä¼ ç»Ÿ IDE æ‰©å±•å¼€å‘



## åã€æ€»ç»“

Claude Code çš„æ¶æ„è®¾è®¡ä½“ç°äº†ç°ä»£ AI åº”ç”¨çš„æœ€ä½³å®è·µï¼š

âœ… **åˆ†å±‚æ¸…æ™°**ï¼šå››å±‚æ¶æ„ï¼ŒèŒè´£æ˜ç¡®
âœ… **Agent ä¼˜å…ˆ**ï¼šAI è‡ªä¸»å†³ç­–ï¼Œå‡å°‘ç”¨æˆ·æ“ä½œ
âœ… **å·¥å…·é©±åŠ¨**ï¼šå¼ºå¤§çš„å·¥å…·ç³»ç»Ÿï¼Œå¯æ‰©å±•æ€§å¼º
âœ… **ä¸Šä¸‹æ–‡ä¸ºç‹**ï¼šæ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œæå‡æ•ˆæœ
âœ… **å®‰å…¨å¯é **ï¼šå¤šå±‚å®‰å…¨æœºåˆ¶ï¼Œé”™è¯¯å¤„ç†å®Œå–„



## ä¸‹ä¸€ç¯‡é¢„å‘Š

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ **[æ ¸å¿ƒå¼•æ“å®ç°](./02-æ ¸å¿ƒå¼•æ“å®ç°.md)**ï¼ŒåŒ…æ‹¬ï¼š
- AI å¼•æ“çš„è¯¦ç»†å®ç°
- Prompt å·¥ç¨‹å’Œç³»ç»Ÿæç¤ºè¯è®¾è®¡
- æµå¼å“åº”å¤„ç†æŠ€æœ¯
- é”™è¯¯æ¢å¤æœºåˆ¶

æ•¬è¯·æœŸå¾…ï¼ ğŸš€



**å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ï¼**
